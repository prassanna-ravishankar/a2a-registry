name: Validate Agent PR

on:
  pull_request:
    paths:
      - 'agents/**.json'
      - 'scripts/validate_agent.py'

jobs:
  validate:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for proper diff

    - name: Set up uv
      uses: astral-sh/setup-uv@v6
      with:
        enable-cache: true

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files: |
          agents/**.json
        json: true

    - name: Validate changed agent files
      id: validate
      run: |
        echo "ðŸ” Validating agent submissions..."

        # Parse the JSON array of changed files
        changed_files='${{ steps.changed-files.outputs.all_changed_files }}'

        # Convert JSON array to space-separated list
        # The output from changed-files action comes with escaped quotes, so we need to unescape first
        files=$(echo "$changed_files" | sed 's/\\\"/"/g' | jq -r '.[]' | tr '\n' ' ')

        if [ -z "$files" ]; then
          echo "â„¹ï¸  No agent files changed in this PR"
          echo "Testing validation script with sample agents..."

          # If validation script was modified but no agents changed, test with sample agents
          if git diff --name-only origin/main...HEAD | grep -q 'scripts/validate_agent.py'; then
            sample_agents=$(ls agents/*.json | head -5)
            for file in $sample_agents; do
              echo ""
              echo "Testing: $file"
              echo "----------------------------------------"
              if ! uv run python scripts/validate_agent.py "$file" --no-remote; then
                echo "âŒ Validation script broken - failed on $file"
                exit 1
              fi
            done
            echo ""
            echo "âœ… Validation script works correctly!"
          else
            echo "Skipping validation - no relevant changes"
          fi
          exit 0
        fi

        validation_failed=false

        for file in $files; do
          echo ""
          echo "Validating: $file"
          echo "----------------------------------------"

          if uv run python scripts/validate_agent.py "$file"; then
            echo "âœ… $file passed validation"
          else
            echo "âŒ $file failed validation"
            validation_failed=true
          fi
        done

        if [ "$validation_failed" = true ]; then
          echo ""
          echo "âŒ One or more agent files failed validation"
          exit 1
        else
          echo ""
          echo "âœ… All agent files passed validation!"
        fi

    - name: Save validation result
      if: always()
      run: |
        mkdir -p ./pr-comment
        echo "${{ github.event.pull_request.number }}" > ./pr-comment/pr-number
        echo "${{ github.run_id }}" > ./pr-comment/run-id
        if [ "${{ steps.validate.outcome }}" == "success" ]; then
          echo "success" > ./pr-comment/status
        else
          echo "failure" > ./pr-comment/status
        fi

    - name: Upload result artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: pr-comment-data
        path: pr-comment/
